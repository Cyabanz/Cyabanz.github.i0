<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progress Page</title>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "firebase/app";
        import { getAnalytics } from "firebase/analytics";
        import { getDatabase, ref, set, get, child, update } from "firebase/database";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "firebase/auth";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDQcJNa_j_PC3-K5er4ms0WvVXQS_CEcuE",
            authDomain: "algebras4-44f23.firebaseapp.com",
            databaseURL: "https://algebras4-44f23-default-rtdb.firebaseio.com",
            projectId: "algebras4-44f23",
            storageBucket: "algebras4-44f23.appspot.com",
            messagingSenderId: "512062724744",
            appId: "1:512062724744:web:653e3c7a504fb7255fdd3d",
            measurementId: "G-4R378XMPSW"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let currentUserId = null;

        // Check user authentication state
        onAuthStateChanged(auth, (user) => {
            const loginButton = document.getElementById("loginButton");
            const claimRewardButton = document.getElementById("claimRewardButton");
            const giveCoinsButton = document.getElementById("giveCoinsButton");
            if (user) {
                currentUserId = user.uid;
                loginButton.style.display = "none"; // Hide login button
                document.getElementById("loggedInMessage").innerText = "You are already logged in as " + user.displayName;
                getCoinBalance();
            } else {
                document.getElementById("coinBalance").innerText = "Please sign in.";
                currentUserId = null;
                loginButton.style.display = "block"; // Show login button
                document.getElementById("loggedInMessage").innerText = ""; // Clear logged-in message
            }
        });

        // Function to fetch and display the user's coin balance
        function getCoinBalance() {
            const userRef = ref(db, 'users/' + currentUserId);
            get(child(userRef, 'coins')).then((snapshot) => {
                if (snapshot.exists()) {
                    const coins = snapshot.val();
                    document.getElementById("coinBalance").innerText = "Your Coin Balance: " + coins;
                } else {
                    document.getElementById("coinBalance").innerText = "No coin balance found.";
                }
            }).catch((error) => {
                console.error("Error fetching coin balance: ", error);
            });
        }

        // Function to claim daily rewards
        function claimDailyReward() {
            if (currentUserId) {
                const userRef = ref(db, 'users/' + currentUserId);
                get(child(userRef, 'lastClaimDate')).then((snapshot) => {
                    const lastClaimDate = snapshot.val();
                    const today = new Date().toISOString().split('T')[0]; // Get current date in YYYY-MM-DD format

                    if (lastClaimDate === today) {
                        alert("You have already claimed your reward today.");
                    } else {
                        const coinsToAdd = Math.floor(Math.random() * 51) + 50; // Generate random coins between 50 and 100
                        update(userRef, {
                            coins: (lastClaimDate ? snapshot.val() : 0) + coinsToAdd,
                            lastClaimDate: today
                        }).then(() => {
                            alert("You have received " + coinsToAdd + " coins!");
                            getCoinBalance(); // Update displayed coin balance
                        }).catch((error) => {
                            console.error("Error updating coins: ", error);
                        });
                    }
                });
            } else {
                alert("You need to sign in first.");
            }
        }

        // Function to give 500 coins to all users
        function giveCoinsToAll() {
            const usersRef = ref(db, 'users');
            get(usersRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const users = snapshot.val();
                    const updates = {};
                    for (const userId in users) {
                        updates[`users/${userId}/coins`] = (users[userId].coins || 0) + 500; // Add 500 coins
                    }
                    update(ref(db), updates).then(() => {
                        alert("500 coins have been given to all users!");
                    }).catch((error) => {
                        console.error("Error giving coins: ", error);
                    });
                } else {
                    alert("No users found.");
                }
            }).catch((error) => {
                console.error("Error fetching users: ", error);
            });
        }

        // Function to sign in with Google
        function signIn() {
            signInWithPopup(auth, provider).then((result) => {
                console.log("User signed in:", result.user);
                // Initialize user data if this is their first sign-in
                const userRef = ref(db, 'users/' + result.user.uid);
                set(userRef, {
                    coins: 0,
                    lastClaimDate: null // No claims yet
                });
            }).catch((error) => {
                console.error("Error signing in:", error);
            });
        }

        // Attach functions to the window object so they can be accessed from HTML
        window.signIn = signIn;
        window.claimDailyReward = claimDailyReward;
        window.giveCoinsToAll = giveCoinsToAll;
    </script>
</head>
<body>
    <h1>Progress Page</h1>
    <button id="loginButton" onclick="signIn()">Login with Google</button>
    <h2 id="loggedInMessage"></h2>
    <h2 id="coinBalance">Please sign in.</h2>
    <button id="claimRewardButton" onclick="claimDailyReward()">Claim Daily Reward</button>
    <button id="giveCoinsButton" onclick="giveCoinsToAll()">Give 500 Coins to All Users</button>
</body>
</html>
