<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            padding: 20px;
        }
        .coin-display {
            font-size: 24px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .item {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            background: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .item img {
            width: 50px;
            height: 50px;
        }
        .purchase-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
        }
        .purchase-button:hover {
            background-color: #45a049;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js";
        import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDQcJNa_j_PC3-K5er4ms0WvVXQS_CEcuE",
            authDomain: "algebras4-44f23.firebaseapp.com",
            databaseURL: "https://algebras4-44f23-default-rtdb.firebaseio.com",
            projectId: "algebras4-44f23",
            storageBucket: "algebras4-44f23.appspot.com",
            messagingSenderId: "512062724744",
            appId: "1:512062724744:web:653e3c7a504fb7255fdd3d",
            measurementId: "G-4R378XMPSW"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let currentUserId = null;
        let coins = 100; // Initial coins (You can load this from the database as needed)

        // Check user authentication state
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                loadItems(); // Load items only if user is authenticated
                loadCoins(); // Load user's coins
            } else {
                alert("Please sign in to purchase items.");
                currentUserId = null;
            }
        });

        // Function to load user's coins
        function loadCoins() {
            const coinsRef = ref(db, 'users/' + currentUserId + '/coins');
            get(coinsRef).then((snapshot) => {
                if (snapshot.exists()) {
                    coins = snapshot.val();
                    updateCoinsDisplay();
                }
            }).catch((error) => {
                console.error("Error fetching coins: ", error);
            });
        }

        // Function to update the coin display
        function updateCoinsDisplay() {
            document.getElementById('coins').innerText = `Coins: ${coins}`;
        }

        // Function to load items for sale
        function loadItems() {
            const items = [
                { img: 'item1.png', cost: 10, name: 'Item 1' },
                { img: 'item2.png', cost: 20, name: 'Item 2' },
                { img: 'item3.png', cost: 30, name: 'Item 3' },
            ];

            const itemsContainer = document.getElementById('items');
            items.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'item';
                itemElement.innerHTML = `
                    <img src="${item.img}" alt="${item.name}">
                    <span>${item.name} - Cost: ${item.cost} coins</span>
                    <button class="purchase-button" onclick="purchaseItem('${item.img}', ${item.cost})">Purchase</button>
                `;
                itemsContainer.appendChild(itemElement);
            });
        }

        // Function to purchase an item
        function purchaseItem(img, cost) {
            if (coins < cost) {
                alert("Not enough coins to purchase this item.");
                return;
            }

            const userRef = ref(db, 'users/' + currentUserId + '/purchasedItems');
            const coinsRef = ref(db, 'users/' + currentUserId + '/coins');

            // Get existing items
            get(userRef).then((snapshot) => {
                const items = snapshot.exists() ? snapshot.val() : [];

                // Add or update the item in the user's inventory
                if (items) {
                    const existingItem = items.find(i => i.img === img);
                    if (existingItem) {
                        existingItem.quantity += 1;
                    } else {
                        items.push({ img: img, quantity: 1 });
                    }
                } else {
                    items = [{ img: img, quantity: 1 }];
                }

                // Save updated items back to the database
                set(userRef, items)
                    .then(() => {
                        // Deduct coins
                        coins -= cost;
                        set(coinsRef, coins)
                            .then(() => {
                                alert("Item purchased successfully!");
                                updateCoinsDisplay();
                            })
                            .catch((error) => {
                                console.error("Error updating coins: ", error);
                            });
                    })
                    .catch((error) => {
                        console.error("Error saving item: ", error);
                    });
            }).catch((error) => {
                console.error("Error fetching inventory: ", error);
            });
        }
    </script>
</head>
<body>
    <h1>Shop</h1>
    <div class="coin-display" id="coins">Coins: 100</div> <!-- Display for user's coins -->
    <div id="items"></div> <!-- Container for displaying items -->
</body>
</html>
