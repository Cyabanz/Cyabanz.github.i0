<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <link rel="stylesheet/less" type="text/css" href="./style.less" />
    <link rel="stylesheet" href="css/all.css">
    <script src="https://cdn.jsdelivr.net/npm/less"></script>

    <style>
        /* Existing styles... */

        /* New styles for games section */
        .game {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 10px 0;
        }
        .game img {
            width: 100%; /* Responsive image */
        }
    </style>
</head>

<body>
    <nav>
        <a href="/">
            <button class="material-icons" active="true">
                home
            </button>
        </a>
        <a href="/games.html">
            <button class="material-icons">
                sports_esports
            </button>
        </a>
        <a href="/leaderboard.html">
            <button class="material-icons">
                diamond 
            </button>
        </a>
        <div class="divider"></div>
        <a href="/settings.html">
            <button class="material-icons">
                settings
            </button>
        </a>
        <a href="/account.html">
            <button class="material-icons">
                account_circle
            </button>
        </a>
    </nav>

    <main id="fusion">
        <h1 style="margin-bottom: 0;">FU<span class="brand-color">SIO</span>N</h1>
        <sub>Officially v2</sub>
        <h2>Home</h2>
        <p id="user-name"></p> <!-- Display the user's name -->

        <!-- Section to display games -->
        <div id="games-list"></div>
    </main>

    <!-- Top-right profile picture -->
    <img id="user-pic-top-right" src="" alt="Profile Picture" />

    <script src="/js/game_embed.js"></script>
    <script src="/js/settings.js"></script>
    <script src="tester2.js"></script>
    
    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getDatabase, ref, set, get, child, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDQcJNa_j_PC3-K5er4ms0WvVXQS_CEcuE",
            authDomain: "algebras4-44f23.firebaseapp.com",
            projectId: "algebras4-44f23",
            storageBucket: "algebras4-44f23.appspot.com",
            messagingSenderId: "512062724744",
            appId: "1:512062724744:web:653e3c7a504fb7255fdd3d",
            measurementId: "G-4R378XMPSW"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // Check authentication state
        onAuthStateChanged(auth, (user) => {
            if (user) {
                const name = localStorage.getItem('userName') || user.displayName;
                const photoURL = localStorage.getItem('userPhoto') || user.photoURL;
                displayUserInfo(name, photoURL, true);
            } else {
                displayUserInfo("Guest", "images/IMG_0164.jpeg", false);
            }
        });

        function displayUserInfo(name, photoURL, isLoggedIn) {
            document.getElementById('user-pic-top-right').src = photoURL;
            document.getElementById('user-pic-top-right').style.display = isLoggedIn ? 'inline' : 'none';
            document.getElementById('user-name').textContent = name;
        }

        // Load games from weed.json
        async function loadGames() {
            const response = await fetch('weed.json'); // Fetching JSON data
            const gamesData = await response.json(); // Parsing JSON data

            const gamesList = document.getElementById('games-list');
            gamesData.forEach(game => {
                const gameDiv = document.createElement('div');
                gameDiv.className = 'game';
                gameDiv.innerHTML = `
                    <h3>${game.title}</h3>
                    <img src="${game.banner}" alt="${game.title}">
                    <p>${game.description}</p>
                    <a href="${game.link}" target="_blank">Play Now</a>
                    <input type="number" min="1" max="5" placeholder="Rate (1-5)" class="rating-input" />
                    <button class="rate-button" data-title="${game.title}">Submit Rating</button>
                    <p class="average-rating">Average Rating: <span id="${game.title}-rating">N/A</span></p>
                `;
                gamesList.appendChild(gameDiv);

                // Load average rating for this game
                loadAverageRating(game.title);
            });

            // Event listener for rating buttons
            document.querySelectorAll('.rate-button').forEach(button => {
                button.addEventListener('click', () => {
                    const ratingInput = button.previousElementSibling;
                    const rating = ratingInput.value;
                    if (rating >= 1 && rating <= 5) {
                        submitRating(game.title, rating);
                    } else {
                        alert("Please enter a valid rating (1-5).");
                    }
                });
            });
        }

        // Load average rating from Firebase
        async function loadAverageRating(gameTitle) {
            const ratingRef = ref(database, `ratings/${gameTitle}`);
            const snapshot = await get(ratingRef);
            if (snapshot.exists()) {
                const ratings = snapshot.val();
                const avgRating = Object.values(ratings).reduce((sum, rate) => sum + rate, 0) / Object.keys(ratings).length;
                document.getElementById(`${gameTitle}-rating`).textContent = avgRating.toFixed(2);
            }
        }

        // Submit rating to Firebase
        async function submitRating(gameTitle, rating) {
            const user = auth.currentUser;
            if (user) {
                const userId = user.uid;
                const ratingRef = ref(database, `ratings/${gameTitle}/${userId}`);
                await set(ratingRef, parseInt(rating));
                alert("Rating submitted successfully!");
                loadAverageRating(gameTitle); // Reload average rating after submission
            } else {
                alert("Please log in to submit a rating.");
            }
        }

        // Initialize the app by loading games
        loadGames();

        // Check if the user has completed the tutorial
        if (!localStorage.getItem('tutorialCompleted')) {
            window.location.href = 'tutorial.html';
        }
    </script>
</body>
</html>
